<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap-3.0.0-wip.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="brand" href="http://github.com/jsoverson/plato">Plato on Github</a>
    <ul class="nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>alarm_manager.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="span6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"></i></a></h2>
      <p class="stat">73.18</p>
    </div>
    <div class="span6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h2>
      <p class="stat">152</p>
    </div>
  </div>
  <div class="row historical">
    <div class="span6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="span6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="span6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty"></i></a></h2>
      <p class="stat">24.67</p>
    </div>
    <div class="span6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs"></i></a></h2>
      <p class="stat">1.02</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="span6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="span6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="span12">/* An Alarm's ID:
 * ID in Clock app                              ID in mozAlarms API
 * id (unique)                                  id (unique)
 * normalAlarmId (comes from mozAlarms API)     type: 'normal' or 'snooze'
 * snoozeAlarmId (comes from mozAlarms API)
 *
 * An alarm has its own id in the Clock app's indexDB(alarmsdb.js).
 * In order to maintain(add,remove) an alarm by mozAlarms API,
 * we prepare two request id(normalAlarmId, snoozeAlarmId) for each alarm.
 * The two id is used to store return id from mozAlarms API.
 * normalAlarmId: Maintain an alarm's life(once, repeat).
 * snoozeAlarmId: Maintain an snooze alarm's life only(snooze).
 *                (If user click snooze button,
 *                 we always maintain it with snoozeAlarmId.)
 *
 * In order to identify the active alarm which comes from mozAlarms API,
 * we pass id and type in JSON object data during adding an alarm by API.
 * id:    sync with each alarm's own id in Clock app's
 * type:  'normal', 'snooze' corresponding alarm type
 *
 *
 * An Alarm's Life:
 * We maintain an alarm's life cycle immediately when the alarm goes off.
 * If user click the snooze button when the alarm goes off,
 * we request a snooze alarm with snoozeAlarmId immediately.
 *
 *
 * Example:
 * (): set a alarm in start state
 * []: alarm goes off
 * O:  an once alarm
 * R:  a repeatable alarm
 * S:  a snooze alarm
 *
 * ====>: the flow of normalAlarmId
 * ---->: the flow of snoozeAlarmId
 * |:     User click the snooze button
 *
 * Flow map:
 * i.  Once Alarm:
 *     (O) ====> [O]
 *
 * or  (O) ====> [O]
 *                |
 *                |  ----> [S] ----> [S]
 *
 *
 * ii. Repeat Alarm:
 *     (R) ====> [R] ====> [R]
 *                |
 *                |  ----> [S] ----> [S]
 *
 *                                              |  ----> [S] ----> [S]
 *                          |  ----> [S]        |
 *                          |                   |
 * or  (R) ====> [R] ====> [R] ====> [R] ====> [R] ====> [R] ====> [R]
 *                |
 *                |  ----> [S] ----> [S]
 */
var AlarmManager = {

  toggleAlarm: function am_toggleAlarm(alarm, enabled, callback) {
    if (enabled) {
      this.set(alarm, false, callback);
    } else {
      this.unset(alarm, callback);
    }
  },

  set: function am_set(alarm, bSnooze, callback) {
    // Do not need to unset repeat alarm when set a snooze alarm
    if (!bSnooze) {
      // Unset the requested alarm which does not goes off
      this.unset(alarm);
    }

    var nextAlarmFireTime = null;
    if (bSnooze) {
      nextAlarmFireTime = new Date();
      nextAlarmFireTime.setMinutes(nextAlarmFireTime.getMinutes() +
                                   alarm.snooze);
    } else {
      nextAlarmFireTime = getNextAlarmFireTime(alarm);
    }

    if (!navigator.mozAlarms)
      return;

    var type = bSnooze ? 'snooze' : 'normal';
    var data = {
      id: alarm.id,
      type: type
    };
    var request = navigator.mozAlarms.add(
                    nextAlarmFireTime,
                    'ignoreTimezone',
                    data);

    // give the alarm id for the request
    var self = this;
    request.onsuccess = function(e) {
      if (bSnooze) {
        alarm.snoozeAlarmId = e.target.result;
      } else {
        alarm.normalAlarmId = e.target.result;
      }

      // save the AlarmAPI's request id to DB
      AlarmsDB.putAlarm(alarm, function am_putAlarm(alarm) {
        if (self._updateAlarmEableStateHandler)
          self._updateAlarmEableStateHandler(alarm);

        if (callback)
          callback(alarm);
      });
      self.updateAlarmStatusBar();
      BannerView.setStatus(nextAlarmFireTime);
    };
    request.onerror = function(e) {
      console.log('onerror!!!!');
      var logInfo = bSnooze ? ' snooze' : '';
      console.log('set' + logInfo + ' alarm fail');
    };

  },

  unset: function am_unset(alarm, callback) {
    var isNeedToUpdateAlarmDB = false;
    if (alarm.normalAlarmId) {
      navigator.mozAlarms.remove(alarm.normalAlarmId);
      alarm.normalAlarmId = '';
      isNeedToUpdateAlarmDB = true;
    }
    if (alarm.snoozeAlarmId) {
      navigator.mozAlarms.remove(alarm.snoozeAlarmId);
      alarm.snoozeAlarmId = '';
      isNeedToUpdateAlarmDB = true;
    }
    if (isNeedToUpdateAlarmDB) {
      // clear the AlarmAPI's request id to DB
      var self = this;
      AlarmsDB.putAlarm(alarm, function am_putAlarm(alarm) {
        if (self._updateAlarmEableStateHandler)
          self._updateAlarmEableStateHandler(alarm);

        if (callback)
          callback(alarm);
      });
      this.updateAlarmStatusBar();
    }

  },

  delete: function am_delete(alarm, callback) {
    if (alarm.normalAlarmId || alarm.snoozeAlarmId)
      this.toggleAlarm(alarm, false);

    var self = this;
    AlarmsDB.deleteAlarm(alarm.id, function am_deletedAlarm() {
      if (callback)
        callback();

    });
  },

  getAlarmList: function am_getAlarmList(callback) {
    AlarmsDB.getAlarmList(function am_gotAlarmList(list) {
      if (callback)
        callback(list);

    });
  },

  getAlarmById: function am_getAlarmById(id, callback) {
    AlarmsDB.getAlarm(id, function am_gotAlarm(alarm) {
      if (callback)
        callback(alarm);

    });
  },

  putAlarm: function am_putAlarm(alarm, callback) {
    AlarmsDB.putAlarm(alarm, function am_putAlarm(alarm) {
      if (callback)
        callback(alarm);

    });
  },

  updateAlarmStatusBar: function am_updateAlarmStatusBar() {
    if (!('mozSettings' in navigator))
      return;
    if (!navigator.mozAlarms)
      return;
    var request = navigator.mozAlarms.getAll();
    request.onsuccess = function(e) {
      var hasAlarmEnabled = !!e.target.result.length;
      navigator.mozSettings.createLock().set({'alarm.enabled':
          hasAlarmEnabled});
      ClockView.showHideAlarmSetIndicator(hasAlarmEnabled);
    };
    request.onerror = function(e) {
      console.log('get all alarm fail');
    };
  },

  regUpdateAlarmEnableState: function am_regUpdateAlarmEnableState(handler) {
    this._updateAlarmEableStateHandler = handler;
  }

};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
