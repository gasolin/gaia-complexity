<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap-3.0.0-wip.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="brand" href="http://github.com/jsoverson/plato">Plato on Github</a>
    <ul class="nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>internet_sharing.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="span6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"></i></a></h2>
      <p class="stat">68.97</p>
    </div>
    <div class="span6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h2>
      <p class="stat">131</p>
    </div>
  </div>
  <div class="row historical">
    <div class="span6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="span6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="span6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty"></i></a></h2>
      <p class="stat">28.34</p>
    </div>
    <div class="span6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs"></i></a></h2>
      <p class="stat">0.71</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="span6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="span6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="span12">/* -*- Mode: js; js-indent-level: 2; indent-tabs-mode: nil -*- */
/* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab: */

'use strict';

/*
 * Internet Sharing module responsible for saving and restoring the internet
 * sharing state, including Wifi hotspot and USB tethering, based on sim card.
 *
 * The sharing state is linked with sim card id, iccid. When a user changes sim
 * card, this module restore the last state of that sim card.
 *
 * If the there is no sim card or sim card is not ready, this module use the
 * settings of no sim card in which Wifi hotspot will always be disabled.
 */

var InternetSharing = (function() {

  var settings;
  var mobileConnection;
  // null or unknown state will change to one of the following state
  var validCardState = ['absent',
                        'pinRequired',
                        'pukRequired',
                        'networkLocked',
                        'corporateLocked',
                        'serviceProviderLocked',
                        'ready'];

  var observerHooked = false;

  var cardState;

  function addObservers() {
    if (observerHooked) {
      return;
    }
    observerHooked = true;
    // listen changes after value is restored.
    ['usb', 'wifi'].forEach(function(type) {
      settings.addObserver('tethering.' + type + '.enabled',
                          internetSharingSettingsChangeHanlder);
    });
  }

  function checkCardAndInternetSharing() {
    cardState = mobileConnection.cardState;
    if (validCardState.indexOf(cardState) > -1) {
      // if it is known cardState, we need to load internet sharing state from
      // settings
      addObservers();
      restoreInternetSharingState(cardState);
    }
  }

  function restoreInternetSharingState(cardState) {
    // the function restores settings based on type, cardId.
    function doRestore(type, cardId, forceDisabled) {
      // build the key for asyncStorage.
      var key = 'tethering.' + type + '.simstate.card-' + cardId;
      asyncStorage.getItem(key, function callback(value) {
        // if forceDisable is true, we need to disable it always.
        var simState = forceDisabled ? false : (value || false);
        // update value for type
        var cset = {};
        cset['tethering.' + type + '.enabled'] = simState;
        settings.createLock().set(cset);
      });
    }
    // the internet sharing is linked with iccid, if cardState is not ready, we
    // just view it as no sim.
    // note if it is under pinRequired or pukRequired, it may turned into ready
    // state after user typed pin or puk.
    if (cardState === 'ready') {
      // once cardState is ready, we need to read iccid
      // if iccInfo.iccid is not ready, we need to listen change of iccinfo
      // change, until iccid is ready
      if (!mobileConnection.iccInfo || !mobileConnection.iccInfo.iccid) {
        mobileConnection.oniccinfochange = function handler() {
          // wait for iccid is filled.
          if (mobileConnection.iccInfo.iccid) {
            mobileConnection.oniccinfochange = null;
            doRestore('usb', mobileConnection.iccInfo.iccid);
            doRestore('wifi', mobileConnection.iccInfo.iccid);
          }
        };
      } else {
        // iccInfo is ready, just use it.
        doRestore('usb', mobileConnection.iccInfo.iccid);
        doRestore('wifi', mobileConnection.iccInfo.iccid);
      }
    } else {
      // card is not ready, just use absent to restore the value.
      doRestore('usb', 'absent');
      // card is not ready, force wifi hotspot disabled.
      doRestore('wifi', 'absent', true);
    }
  }

  function internetSharingSettingsChangeHanlder(evt) {
    if (validCardState.indexOf(cardState) === -1) {
      return;
    }
    // link the iccid with current internet state for future restoring.
    var type = (evt.settingName.indexOf('wifi') > -1) ? 'wifi' : 'usb';
    var cardId = mobileConnection.iccInfo.iccid || 'absent';
    // wifi hotspot cannot be enabled without sim
    if ('wifi' === type && 'absent' === cardId && true === evt.settingValue) {
      settings.createLock().set({'tethering.wifi.enabled': false});
      return;
    }
    asyncStorage.setItem('tethering.' + type + '.simstate.card-' + cardId,
                         evt.settingValue);
  }

  function _init() {
    settings = window.navigator.mozSettings;
    if (!settings) {
      return;
    }
    mobileConnection = window.navigator.mozMobileConnection;
    if (!mobileConnection) {
      return;
    }
    observerHooked = false;
    checkCardAndInternetSharing();
    // listen cardstatechange event for ready, pin, puk, or network unlocking.
    mobileConnection.addEventListener('cardstatechange',
                                      checkCardAndInternetSharing);
  }
  return {init: _init};
})();

InternetSharing.init();</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
